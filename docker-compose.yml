version: "3.9"

x-common-resources: &default-resources
  deploy:
    resources:
      limits:
        cpus: '1'
        memory: 512M
      reservations:
        cpus: '0.5'
        memory: 256M

networks:
  park20:
    name: park20
    driver: bridge
    external: true

services:
  eureka:
    build:
      context: ./eureka
      dockerfile: Dockerfile
    environment:
      EUREKA_CLIENT_REGISTER-WITH-EUREKA: "false"
      EUREKA_CLIENT_FETCH-REGISTRY: "false"
      eureka.client.registerWithEureka: "false"
      eureka.client.fetchRegistry: "false"
      # without this, eureka keeps trying to register itself for some reason
      eureka.server.maxThreadsForPeerReplication: 0
    ports:
        - "8761:8761"
    networks:
      - park20

  #Spring API Gateway
  gateway:
    <<: *default-resources
    depends_on:
      eureka:
        condition: service_started
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    environment:
      eureka.client.service-url.defaultZone: http://host.docker.internal:8761/eureka
      eureka.instance.ip-address: host.docker.internal
    ports:
      - "8080:8080"
    networks:
      - park20

  #User BackOffice 1
  users:
    <<: *default-resources
    container_name: users
    depends_on:
      - eureka
    build:
        context: ./users_bo_mcs
        dockerfile: Dockerfile
    restart: on-failure
    environment:
      eureka.client.service-url.defaultZone: http://host.docker.internal:8761/eureka
      eureka.instance.ip-address: host.docker.internal
      spring.application.name: park20-user-microservice
      SPRING_DATASOURCE_URL: jdbc:postgresql://host.docker.internal:5510/
      spring.rabbitmq.host: rabbitmq4
      server.port: 8090
      spring.profiles.active: bootstrap
    ports:
      - "8090:8090"
    networks:
      - park20

  #Ballerina API Gateway
  ballgateway:
    <<: *default-resources
    build:
      context: ./bal_api_gateway/target/docker/bal_api_gateway
      dockerfile: Dockerfile
    environment:
      eureka.client.service-url.defaultZone: http://host.docker.internal:8761/eureka
      eureka.instance.ip-address: host.docker.internal
    ports:
      - "9090:9090"
    networks:
      - park20